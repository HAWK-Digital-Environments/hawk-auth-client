(function(u,l){typeof exports=="object"&&typeof module<"u"?module.exports=l():typeof define=="function"&&define.amd?define(l):(u=typeof globalThis<"u"?globalThis:u||self,u.HawkAuthClient=l())})(this,function(){"use strict";const u=["auth-state-changed","login","logout","token-refresh","error"],l=["token","refresh-token","token-expires","id-token","code-verifier","state","redirect-url-after-login","callback-url","trigger-event-after-redirect"];function P(t){const e=new FormData;for(const r in t)t.hasOwnProperty(r)&&e.append(r,t[r]);return e}function y(t,e,r){const n=t.endpointUrl,o=n.searchParams;if(r)for(const a in r)o.set(a,r[a]);return o.set("hawk-api-route",e),o.set("state",t.storage.get("state")),n}function k(t,e,r){return t.status!==200&&e.dispatchError("fetch-backend-data-failed",`Failed to fetch data from backend: [${t.status}], endpoint: ${r}`),t}async function f(t,e,r){return k(await fetch(y(t,e),{method:"POST",body:P(r)}),t,e)}async function h(t,e,r){return k(await b(t,y(t,e,r),{method:"GET",cache:"default"}),t,e)}async function c(t,e=null){return t.status!==200?e:t.headers.get("content-type")!=="application/json"?await t.text():await t.json()}function d(t,e,r){return t.status===404&&e.dispatchError("missing-optional-feature",`The feature "${r}" is not enabled in your api.`),t}function A(t,e){const r=e.errorHandler??((i,s)=>console.error("Auth Client error:",i,s)),n=(i,s)=>{new CustomEvent("error",{detail:{error:i,message:s},cancelable:!0}).defaultPrevented||r(i,s)},o=L();return{get currentUrl(){return new URL(e.currentUrl||window.location.href)},get endpointUrl(){return new URL(e.endpointUrl||this.currentUrl.href)},dispatchEvent:(i,s)=>{t.dispatchEvent(s instanceof Event?s:new CustomEvent(i,{detail:s,cancelable:!0}))},dispatchError:n,storage:o}}function L(t){t=t||"hawk_auth_client_";const e=r=>t+r;return{clear:()=>{l.map(r=>sessionStorage.removeItem(e(r)))},remove:r=>{sessionStorage.removeItem(e(r))},set:(r,n)=>{sessionStorage.setItem(e(r),n)},get:r=>sessionStorage.getItem(e(r))}}async function m(t,e){const r=await c(e);return!r||!r.token||!r.expires||!r.idToken?(t.dispatchError("invalid-token-response","Failed to refresh token"),F(t),!1):(t.storage.set("token",r.token),t.storage.set("token-expires",r.expires),t.storage.set("refresh-token",r.refreshToken),t.storage.set("id-token",r.idToken),t.dispatchEvent("auth-state-changed"),!0)}function v(t){const e=()=>{const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return a.charAt(Math.floor(Math.random()*a.length))},r=()=>{const a=new Uint32Array(1);return window.crypto.getRandomValues(a),a[0]},n=()=>r()%2===0?"a":"b";let o="";for(;o.length<t;)o+=n()==="a"?e():r();return o.substring(0,t)}async function R(t){const r=new TextEncoder().encode(t);return await window.crypto.subtle.digest("SHA-256",r)}function T(t){return btoa(String.fromCharCode.apply(null,new Uint8Array(t))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function C(t){const e=await R(t);return T(e)}async function E(t){const e=await c(d(await h(t,"user-info",{}),t,"user-info"));if(!e||typeof e!="object")return null;const r=(e==null?void 0:e.claims)??{};for(const n in r)if(r.hasOwnProperty(n)){const o=g(n);e.hasOwnProperty(o)||(e[o]=r[n])}return Object.defineProperty(e,"profile",{get:async function(){return await O(t)}}),e}function g(t){return t.replace(/[-_](.)/g,(e,r)=>r.toUpperCase())}async function O(t){var o;const e=await c(d(await h(t,"user-profile",{}),t,"user-profile"));if(!e||typeof e!="object")return null;const r=((o=e==null?void 0:e.structure)==null?void 0:o.attributesLocal)??{};for(const a in r)if(r.hasOwnProperty(a)){const i=g(a);e.hasOwnProperty(i)||(e[i]=e.attributes[r[a]]??void 0)}const n=(e==null?void 0:e.additionalData)??{};for(const a in n)if(n.hasOwnProperty(a)){const i=g(a);e.hasOwnProperty(i)||(e[i]=n[a])}return e}async function S(t,e){const r=await c(d(await h(t,"permissions",{resource:e}),t,"permissions"));return!r||!Array.isArray(r==null?void 0:r.scopes)?[]:r.scopes}function p(t,...e){for(const r of e)if(t.includes(r))return!0;return!1}function j(t,e){return t.indexOf(e)===0}function D(t,...e){const r=(n,o)=>{const a=n.replace(/^\//,""),i=o.replace(/^\//,"");if(a===i||j(a,i))return!0};for(const n of e)for(const o of t)if(r(o,n))return!0;return!1}class H{constructor(e,r){this.context=e,this.userFactory=r}async hasAnyRole(...e){const r=await this.userFactory();return r===null?!1:p(r.roles,...e)}async hasAnyGroup(...e){const r=await this.userFactory();return r===null?!1:p(r.groups,...e)}async hasAnyOrHasChildOfAny(...e){const r=await this.userFactory();return r===null?!1:D(r.groups,...e)}async hasAnyResourceScope(e,...r){const n=await S(this.context,e);return r.length===0?n.length>0:p(n,...r)}}function U(t){const e=t.get("token-expires");return e===null?!0:Date.now()>parseInt(e,10)*1e4}async function N(t,e,r,n){const o=await c(await f(t,"auth-login-url",{redirectUrl:e+"",codeChallenge:r,state:n}));if(!o||typeof o!="object"||!o.url||o.url.length===0)throw t.dispatchError("login-failed-to-fetch-url","Failed to fetch login URL"),new Error("Failed to fetch login URL");return o.url}async function B(t,e,r){const n=await c(await f(t,"auth-logout-url",{redirectUrl:r+"",idToken:e}));if(!n||typeof n!="object"||!n.url||n.url.length===0)throw t.dispatchError("logout-failed-to-fetch-url","Failed to fetch logout URL"),new Error("Failed to fetch logout URL");return n.url}function I(t){const e=t.currentUrl,r=e.searchParams;return r.delete("code"),r.delete("state"),r.delete("session_state"),r.delete("iss"),r.set("frontend-login","true"),e}async function _(t,e){const r=t.storage;r.clear();try{const n=v(128);r.set("code-verifier",n),r.set("redirect-url-after-login",(e||t.currentUrl)+"");const o=I(t);r.set("callback-url",o+"");const a=await C(n),i=v(64);r.set("state",i),window.location.href=await N(t,o,a,i)}catch(n){throw t.dispatchError("login-failed","Failed to start login flow: "+n.message),new Error("Failed to fetch login URL: "+n)}}async function G(t){const e=t.storage,r=e.get("state");if(r===null)return;const n=t.currentUrl.searchParams;if(!n.has("frontend-login"))return;if(n.get("state")!==r){t.dispatchError("login-state-mismatch","State mismatch, either not our request or CSRF attack; ignoring"),e.clear();return}const o=n.get("code");if(o===null){e.clear(),t.dispatchError("login-callback-missing-code","No code in URL");return}const a=e.get("code-verifier");if(a===null){e.clear(),t.dispatchError("login-callback-misses-verifier","No code verifier in storage");return}if(!await m(t,await f(t,"auth-exchange-code-for-token",{code:o,codeVerifier:a,redirectUrl:e.get("callback-url")+""}))){t.dispatchError("login-failed-to-fetch-token","Failed to fetch token");return}const i=e.get("redirect-url-after-login");e.remove("code-verifier"),e.remove("callback-url"),e.remove("redirect-url-after-login"),e.set("trigger-event-after-redirect","login"),window.location.href=i}async function $(t,e){const r=new URL((e||t.currentUrl)+""),n=o=>{t.dispatchError("logout-failed",o),window.location.href=r.href};try{const o=t.storage.get("id-token");if(o===null){n("No id token found");return}const a=await B(t,o,r);F(t),window.location.href=a}catch(o){n("An error occurred: "+o.message)}}async function w(t){const e=t.storage.get("refresh-token"),r=t.storage.get("state");return e===null?(t.dispatchError("failed-to-refresh-token","No refresh token found"),t.storage.clear(),!1):await m(t,await f(t,"auth-refresh-token",{refreshToken:e+""}))?(t.storage.set("state",r),t.dispatchEvent("token-refresh"),!0):(t.dispatchError("failed-to-refresh-token","Failed to refresh token"),!1)}async function b(t,e,r){const n=()=>{const a=r||{};a.headers=a.headers||{};const i=t.storage.get("token");return i!==null&&(a.headers.Authorization="Bearer "+i),a},o=await fetch(e,n());if(o.status===401){if(!await w(t))throw t.dispatchError("authenticated-fetch-failed","Failed to refresh token"),new Error("Failed to refresh token, cannot authenticate request");return await fetch(e,n())}return o}function q(t){const e=t.storage,r=e.get("trigger-event-after-redirect");u.indexOf(`${r}`)!==-1&&t.dispatchEvent(r),e.remove("trigger-event-after-redirect")}async function z(t){return q(t),await G(t),new K(t)}function F(t){t.dispatchEvent("auth-state-changed"),t.storage.clear(),t.storage.set("trigger-event-after-redirect","logout")}class K{constructor(e){this.authenticatedPromise=null,this.context=e}getToken(){return this.context.storage.get("token")}isAuthenticated(){return this.authenticatedPromise===null&&(this.authenticatedPromise=new Promise(async e=>{const r=this.context.storage;if(r.get("token")===null){e(!1);return}if(U(r)){if(await w(this.context)){e(!U(r));return}e(!1);return}e(!0)}).then(e=>(this.authenticatedPromise=null,e))),this.authenticatedPromise}async fetch(e,r){return b(this.context,e,r)}refreshToken(){return w(this.context)}async getUser(){return E(this.context)}async getProfile(){return E(this.context)}getGuard(){return new H(this.context,()=>this.getUser())}}class M extends EventTarget{constructor(e){super(),this.authentication=null,this.context=A(this,e)}addEventListener(e,r,n){super.addEventListener(e,r,n)}removeEventListener(e,r,n){super.removeEventListener(e,r,n)}login(e){return _(this.context,e)}logout(e){return $(this.context,e)}async getAuth(){return this.authentication===null&&(this.authentication=z(this.context)),await this.authentication}}return M});
